<?php

ini_set('timezone', 'Asia/Shanghai');

function getIP()
{
    if (@$_SERVER['HTTP_X_FORWARDED_FOR']) {
        $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
    } elseif (@$_SERVER['HTTP_CLIENT_IP']) {
        $ip = $_SERVER['HTTP_CLIENT_IP'];
    } elseif (@$_SERVER['REMOTE_ADDR']) {
        $ip = $_SERVER['REMOTE_ADDR'];
    } elseif (@getenv('HTTP_X_FORWARDED_FOR')) {
        $ip = getenv('HTTP_X_FORWARDED_FOR');
    } elseif (@getenv('HTTP_CLIENT_IP')) {
        $ip = getenv('HTTP_CLIENT_IP');
    } elseif (@getenv('REMOTE_ADDR')) {
        $ip = getenv('REMOTE_ADDR');
    } else {
        $ip = 'Unknown';
    }

    return $ip;
}

function is_login()
{
    if (!empty($_SESSION['OPENID'])) {
        return valid_OPENID($_SESSION['OPENID']);
    } else {
        return false;
    }
}

function valid_OPENID($OPENID)
{
    $db = new Model('users');
    if (is_string($OPENID)) {
        $result = $db->find(['OPENID=:OPENID', ':OPENID' => $OPENID]);
        if (empty($result)) {
            return false;
        } else {
            return true;
        }
    } else {
        return false;
    }
}

function sendRetrievePasswordEmail($email_address, $uid, $OPENID, $ATSAST_DOMAIN)
{
    $retrieveid = sha1($OPENID.$uid);
    $msg_content = '<html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;"> <title>Notify</title> <style type="text/css"> svg{width: 60px;height: 60px;} div, p, a, li, td { -webkit-text-size-adjust:none; } *{-webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; } .ReadMsgBody {width: 100%; background-color: #ffffff;} .ExternalClass {width: 100%; background-color: #ffffff;} body{width: 100%; height: 100%; background-color: #ffffff; margin:0; padding:0; -webkit-font-smoothing: antialiased;} html{width: 100%; background-color: #ffffff;} p {padding: 0!important; margin-top: 0!important; margin-right: 0!important; margin-bottom: 0!important; margin-left: 0!important; } .hover:hover {opacity:0.85;filter:alpha(opacity=85);} .image77 img {width: 77px; height: auto;} .avatar125 img {width: 125px; height: auto;} .icon61 img {width: 61px; height: auto;} .logo img {width: 75px; height: auto;} .icon18 img {width: 18px; height: auto;} </style> <!-- @media only screen and (max-width: 640px) {*/ --> <style type="text/css"> @media only screen and (max-width: 640px){body{width:auto!important;} table[class=full2] {width: 100%!important; clear: both; } table[class=mobile2] {width: 100%!important; padding-left: 20px; padding-right: 20px; clear: both; } table[class=fullCenter2] {width: 100%!important; text-align: center!important; clear: both; } td[class=fullCenter2] {width: 100%!important; text-align: center!important; clear: both; } td[class=pad15] {width: 100%!important; padding-left: 15px; padding-right: 15px; clear: both;} } </style> <!-- @media only screen and (max-width: 479px) {--> <style type="text/css"> @media only screen and (max-width: 479px){body{width:auto!important;} table[class=full2] {width: 100%!important; clear: both; } table[class=mobile2] {width: 100%!important; padding-left: 20px; padding-right: 20px; clear: both; } table[class=fullCenter2] {width: 100%!important; text-align: center!important; clear: both; } td[class=fullCenter2] {width: 100%!important; text-align: center!important; clear: both; } table[class=full] {width: 100%!important; clear: both; } table[class=mobile] {width: 100%!important; padding-left: 20px; padding-right: 20px; clear: both; } table[class=fullCenter] {width: 100%!important; text-align: center!important; clear: both; } td[class=fullCenter] {width: 100%!important; text-align: center!important; clear: both; } td[class=pad15] {width: 100%!important; padding-left: 15px; padding-right: 15px; clear: both;} .erase {display: none;} } } </style> </head> <body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0"> <!-- Notification 5 --> <table width="100%" border="0" cellpadding="0" cellspacing="0" align="center" class="full" bgcolor="#303030" style="background-color: rgb(240,240,240);"> <tbody> <tr mc:repeatable=""> <td style="-webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover;background-position: center center;background-repeat: no-repeat;" id="not5"> <div mc:hideable=""> <!-- Mobile Wrapper --> <table width="100%" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile2"> <tbody> <tr> <td width="100%" height="100" align="center"> <div class="sortable_inner ui-sortable"> <!-- Space --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="full" object="drag-module-small"> <tbody> <tr> <td width="352" height="50"> </td> </tr> </tbody> </table> <!-- End Space --> <!-- Space --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="full" object="drag-module-small"> <tbody> <tr> <td width="352" height="50"> </td> </tr> </tbody> </table> <!-- End Space --> </div> </td> </tr> </tbody> </table> <table width="392" border="0" cellpadding="0" cellspacing="0" align="center" class="full"> <tbody> <tr style=""> <td align="center" width="20" valign="middle"> </td> <td align="center" width="352" valign="middle" style=" "> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="full"> <tbody> <tr style=" \\: 0 5px 50px rgba(0,0,0,.5); "> <td align="center" width="352" valign="middle" bgcolor="#ffffff" style="border: 1px rgba(0,0,0,.1) solid;"> <div class="sortable_inner ui-sortable" style=" "> <!-- Start Top --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody style=" "> <tr style=" "> <td width="352" valign="middle" style=" "> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="30"> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle" class="icon61" align="center"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%"> <span> <svg style="width: 60px;height: 60px;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="60" height="60" viewbox="0 0 1024 1024" version="1.1"><defs><style type="text/css"></style></defs><path d="M512 64C264.64 64 64 264.64 64 512c0 247.424 200.64 448 448 448 247.488 0 448-200.576 448-448C960 264.64 759.488 64 512 64zM512 768c-26.432 0-48-21.504-48-48S485.568 672 512 672c26.624 0 48 21.504 48 48S538.624 768 512 768zM560 528C560 554.56 538.624 576 512 576 485.568 576 464 554.56 464 528l0-224C464 277.44 485.568 256 512 256c26.624 0 48 21.44 48 48L560 528z" p-id="7544" fill="#f44336"></path></svg> </span> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="30"> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle" align="center"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td valign="middle" width="100%" style="text-align: center; font-family: Microsoft Yahei, Arial, sans-serif; font-size: 23px; color: rgb(63, 67, 69); line-height: 28px; font-weight: bold;" class="fullCenter" mc:edit="31"> <!--[if !mso]><!--><span style="font-family: \'Microsoft Yahei\', Microsoft Yahei; font-weight: normal;"><!--<![endif]-->Hey ，您好！<!--[if !mso]><!--></span><!--<![endif]--> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="30"> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle" align="center"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td valign="middle" width="100%" style="text-align: center; font-family: Microsoft Yahei, Arial, sans-serif; font-size: 40px; color: rgb(63, 67, 69); line-height: 46px; font-weight: bold;" class="fullCenter" mc:edit="32"> <!--[if !mso]><!--><p style="font-family: \'proxima_nova_rgbold\', Microsoft Yahei; font-weight: normal;line-height: 1.5;"><!--<![endif]-->找回密码<!--[if !mso]><!--></p><!--<![endif]--> <!--[if !mso]><!--><p style="font-family: \'proxima_nova_rgbold\', Microsoft Yahei; font-weight: normal;line-height: 1.5;"><!--<![endif]-->ATSAST<!--[if !mso]><!--></p><!--<![endif]--> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="30"> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <!-- Divider --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle"> <!-- Header Text --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="10"> </td> </tr> <tr> <td width="100%" height="1" bgcolor="#e5e5e5" style="font-size: 1px; line-height: 1px;"> &nbsp; </td> </tr> <tr> <td width="100%" height="10"> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <!-- End Divider --> <!-- Start 2nd --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle" align="center"> <!-- Buttons + Text --> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="30"> </td> </tr> <tr> <td valign="middle" width="100%" style="text-align: center; font-family: Microsoft Yahei, Arial, sans-serif; font-size: 14px; color: rgb(63, 67, 69); line-height: 24px;" class="fullCenter" mc:edit="33"> <!--[if !mso]><!--> <p style="text-align: left; font-family: \'proxima_nova_rgregular\', Microsoft Yahei; font-weight: normal;"> <!--<![endif]-->亲爱的 '.explode('@', $email_address)[0].'：<!--[if !mso]><!--> </p> <!--<![endif]--> <!--[if !mso]><!--> <p style="text-align: left; font-family: \'proxima_nova_rgregular\', Microsoft Yahei; font-weight: normal;text-indent: 2em;"> <!--<![endif]-->如果您忘记了您的密码，请点击下面的按钮重置您的密码：<!--[if !mso]><!--> </p> <!--<![endif]--> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="40"> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle" align="center"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <!----------------- Button Center -----------------> <tbody> <tr> <td align="center"> <table border="0" cellpadding="0" cellspacing="0" align="center" style=" "> <tbody> <tr> <td align="center" height="35" bgcolor="#ffffff" style="border-top-left-radius: 20px;border-top-right-radius: 20px;border-bottom-right-radius: 20px;border-bottom-left-radius: 20px;padding-left: 30px;padding-right: 30px;font-weight: bold;font-family: Microsoft Yahei, Arial, sans-serif;color: rgb(255, 255, 255);background-color: rgb(254, 70, 70);" mc:edit="34"> <!--[if !mso]><!--><span style="font-family: \'proxima_nova_rgbold\', Microsoft Yahei; font-weight: normal;"><!--<![endif]--> <a href="'.$ATSAST_DOMAIN.'/account/passReset?uid='.$uid.'&ret='.$retrieveid.'" style="color: rgb(255, 255, 255); font-size: 14px; text-decoration: none; line-height: 35px; width: 100%;">立即重置</a> <!--[if !mso]><!--></span><!--<![endif]--> </td> </tr> </tbody> </table> </td> </tr> <tr> <td width="100%" height="12"> </td> </tr> <!----------------- End Button Center -----------------> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="20"> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <!-- Divider --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle" align="center"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <!----------------- End Button Center -----------------> <tbody> <tr> <td valign="middle" width="100%" style="text-align: center; font-family: Microsoft Yahei, Arial, sans-serif; font-size: 14px; color: rgb(63, 67, 69); line-height: 24px;" class="fullCenter" mc:edit="38"> <!--[if !mso]><!--> <p style="font-family: \'proxima_nova_rgregular\', Microsoft Yahei; font-weight: normal;"> <!--<![endif]-->或者复制此链接到浏览器<!--[if !mso]><!--> </p> <!--<![endif]--> <!--[if !mso]><!--> <p style="font-family: \'proxima_nova_rgregular\', Microsoft Yahei; font-weight: normal;"> <!--<![endif]-->'.$ATSAST_DOMAIN.'/account/passReset?uid='.$uid.'&ret='.$retrieveid.'<!--[if !mso]><!--> </p> <!--<![endif]--> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" bgcolor="#ffffff" object="drag-module-small" style="background-color: rgb(255, 255, 255);"> <tbody> <tr> <td width="352" valign="middle"> <table width="300" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" height="40"> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <!-- End 3th --> </div> </td> </tr> </tbody> </table> </td> <td align="center" width="20" valign="middle"> </td> </tr> </tbody> </table> <!-- Mobile Wrapper --> <table width="100%" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile2"> <tbody> <tr> <td width="100%" height="100" align="center"> <div class="sortable_inner ui-sortable"> <!-- Space --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="full" object="drag-module-small"> <tbody> <tr> <td width="352" height="40"> </td> </tr> </tbody> </table> <!-- End Space --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="mobile" object="drag-module-small"> <tbody> <tr> <td width="352" valign="middle" align="center"> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" style="text-align: center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="fullCenter"> <tbody> <tr> <td width="100%" style="text-align: center;font-family: Microsoft Yahei, Arial, sans-serif;font-size: 14px;color: rgb(15, 15, 15);line-height: 24px;" class="fullCenter" mc:edit="21_736372"> <!--[if !mso]><!--><span style="font-family: \'proxima_nova_rgregular\', Microsoft Yahei;"><!--<![endif]--><!--subscribe--> <p style=""> © 2018 ATSAST<br>Auxiliary Teaching for Students\' Association for Science and Technology </p> <!--unsub--><!--[if !mso]><!--></span><!--<![endif]--> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <!-- Space --> <table width="352" border="0" cellpadding="0" cellspacing="0" align="center" class="full" object="drag-module-small"> <tbody> <tr> <td width="352" height="50"> </td> </tr> </tbody> </table> <!-- End Space --> </div> </td> </tr> </tbody> </table> </div> </td> </tr> </tbody> </table> <!-- End Notification 5 --> <style> body{ background: none !important; } </style> </body> </html>';
    $mail = new PHPMailer(true);
    $mail->IsSMTP();
    $mail->CharSet = 'UTF-8';
    $mail->SMTPAuth = true;
    $mail->SMTPSecure = 'ssl';
    $mail->Port = 465;
    $mail->Host = CONFIG::GET('MAIL_HOST');
    $mail->Username = CONFIG::GET('MAIL_USER');
    $mail->Password = CONFIG::GET('MAIL_PASS');
    $mail->AddReplyTo(CONFIG::GET('MAIL_USER'), '南京邮电大学大学生科学技术协会'); //回复地址
    $mail->From = CONFIG::GET('MAIL_USER');
    $mail->FromName = '南京邮电大学大学生科学技术协会';
    $mail->AddAddress($email_address);
    $mail->Subject = '【SAST办公自动化系统】找回密码';
    $mail->Body = $msg_content;
    $mail->AltBody = '找回地址为：'.$ATSAST_DOMAIN."/account/retrieve?id='.$uid.'&ret=".$OPENID.'，请使用一个支持HTML视图的邮箱服务来查看本激活邮件！';
    $mail->WordWrap = 80;
    $mail->IsHTML(true);
    $mail->Send();

    return true;
}

//通过uid判断用户是否有管理员权限
//现该方法已迁移至BaseController
/* function valid_auth($uid)
{
    $db_authority = new Model('Authority');
    $result = $db_authority->find(['uid=:uid','uid' => $uid]);
    $auth = $result['auth'];
    $forever = $result['forever'];
    $until = strtotime($result['until']);

    $currentTime = time();

    if ($auth == 1 || $auth == 2) {
        if ($forever == 1) {
            return true;
        } elseif ($currentTime <= $until) {
            return true;
        } else {
            $db_authority->update(['uid=:uid',':uid'=>$uid],['auth'=>'0','forever'=>'1']);
            return false;
        }
    } else {
        return false;
    }
} */
